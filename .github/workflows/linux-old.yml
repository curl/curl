# Copyright (C) Daniel Fandrich, <dan@coneharvesters.com>, et al.
#
# SPDX-License-Identifier: curl
#
# Compile on an old version of Linux that has barely the minimal build
# requirements for CMake. This tests that curl is still usable on really
# outdated systems.
#
# Debian stretch is chosen as it closely matches some of the oldest major
# versions we support (especially cmake); see docs/INTERNALS.md and it
# is still supported (as of this writing).
# stretch has ELTS support from Freexian until 2027-06-30
# For ELTS info see https://www.freexian.com/lts/extended/docs/how-to-use-extended-lts/
# The Debian key expires 2025-05-20, after which package signature
# verification may need to be disabled.
# httrack is one of the smallest downloaders, needed to bootstrap ELTS,
# and doesn not conflict with the curl we are building.

name: 'Linux Old'

'on':
  push:
    branches:
      - master
      - '*/ci'
    paths-ignore:
      - '**/*.md'
      - '.circleci/**'
      - 'appveyor.*'
      - 'Dockerfile'
      - 'packages/**'
      - 'plan9/**'
      - 'projects/**'
  pull_request:
    branches:
      - master
    paths-ignore:
      - '**/*.md'
      - '.circleci/**'
      - 'appveyor.*'
      - 'Dockerfile'
      - 'packages/**'
      - 'plan9/**'
      - 'projects/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions: {}

env:
  MAKEFLAGS: -j 5
  CURL_CI: github
  DEBIAN_FRONTEND: noninteractive

jobs:
  cmake-autotools:
    name: 'autotools & cmake'
    runs-on: 'ubuntu-latest'
    container: 'debian:stretch'

    env:
      CMAKE_VERSION: '3.18.4'
    steps:
      - name: 'install prereqs'
        # Remember, this shell is dash, not bash
        run: |
          sed -E -i -e s@[a-z]+\.debian\.org/@archive.debian.org/debian-archive/@ -e '/ stretch-updates /d' /etc/apt/sources.list
          apt-get -o Dpkg::Use-Pty=0 update
          # See comment above if this fails after 2025-05-20
          apt-get -o Dpkg::Use-Pty=0 install -y --no-install-suggests --no-install-recommends httrack
          httrack --get https://deb.freexian.com/extended-lts/pool/main/f/freexian-archive-keyring/freexian-archive-keyring_2022.06.08_all.deb
          dpkg -i freexian-archive-keyring_2022.06.08_all.deb
          echo 'deb http://deb.freexian.com/extended-lts stretch-lts main contrib non-free' | tee /etc/apt/sources.list.d/extended-lts.list
          apt-get -o Dpkg::Use-Pty=0 update
          apt-get -o Dpkg::Use-Pty=0 install -y --no-install-suggests --no-install-recommends make automake autoconf libtool gcc pkg-config libpsl-dev libzstd-dev zlib1g-dev libc-ares-dev libkrb5-dev libldap2-dev librtmp-dev stunnel4
          # GitHub's actions/checkout needs newer glibc and libstdc++. The latter also depends on
          # gcc-8-base, but it does not actually seem used in our situation and is not available in
          # the main repo, so force the install.
          httrack --get https://deb.freexian.com/extended-lts/pool/main/g/glibc/libc6_2.28-10+deb10u5_amd64.deb
          httrack --get https://deb.freexian.com/extended-lts/pool/main/g/gcc-8/libstdc++6_8.3.0-6_amd64.deb
          dpkg -i --force-depends libc6_*_amd64.deb libstdc++6_*_amd64.deb

      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: 'install prereqs (cmake)'
        run: |
          fn="cmake-${CMAKE_VERSION}-linux-x86_64"
          httrack --get "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/${fn}.tar.gz"
          tar -xf "${fn}".tar*.gz
          rm -f "${fn}".tar*.gz
          mv cmake-${CMAKE_VERSION}-Linux-x86_64 cmake
          echo "|$PWD|"
          pwd

      - name: 'CM build-only configure (out-of-tree)'
        run: |
          echo "|$PWD|"
          pwd
          mkdir bld-1
          cd bld-1
          cmake/bin/cmake .. -DCMAKE_UNITY_BUILD=ON -DCURL_WERROR=ON -DBUILD_SHARED_LIBS=ON \
            -DCURL_ENABLE_SSL=OFF -DENABLE_ARES=OFF -DCURL_ZSTD=OFF -DCURL_USE_GSSAPI=OFF -DCURL_USE_LIBSSH2=OFF -DCURL_USE_LIBSSH=OFF -DUSE_LIBRTMP=ON

      - name: 'CM build-only build'
        run: VERBOSE=1 make -C bld-1 install

      - name: 'CM build-only curl -V'
        run: bld-1/src/curl --disable --version

      - name: 'CM build-only configure log'
        if: ${{ !cancelled() }}
        run: cat bld-1/CMakeFiles/CMake*.log 2>/dev/null || true

      - name: 'CM build-only curl_config.h'
        run: |
          echo '::group::raw'; cat bld-1/lib/curl_config.h || true; echo '::endgroup::'
          grep -F '#define' bld-1/lib/curl_config.h | sort || true

      # when this job can get a libssh version 0.9.0 or later, this should get
      # that enabled again
      - name: 'CM configure (out-of-tree, c-ares, zstd, gssapi)'
        run: |
          mkdir bld-cares
          cd bld-cares
          cmake/bin/cmake .. -DCMAKE_UNITY_BUILD=ON -DCURL_WERROR=ON -DBUILD_SHARED_LIBS=ON \
            -DCURL_ENABLE_SSL=OFF -DENABLE_ARES=ON -DCURL_USE_GSSAPI=ON -DCURL_USE_LIBSSH2=OFF -DCURL_USE_LIBSSH=OFF -DUSE_LIBRTMP=ON \
            -DCURL_LIBCURL_VERSIONED_SYMBOLS=ON

      - name: 'CM configure log'
        if: ${{ !cancelled() }}
        run: cat bld-cares/CMakeFiles/CMake*.log 2>/dev/null || true

      - name: 'CM curl_config.h'
        run: |
          echo '::group::raw'; cat bld-cares/lib/curl_config.h || true; echo '::endgroup::'
          grep -F '#define' bld-cares/lib/curl_config.h | sort || true

      - name: 'CM build'
        run: make -C bld-cares

      - name: 'CM curl -V'
        run: bld-cares/src/curl --disable --version

      - name: 'CM install'
        run: make -C bld-cares install

      - name: 'CM build tests'
        run: make -C bld-cares testdeps

      - name: 'CM run tests'
        run: make -C bld-cares test-ci

      - name: 'CM build examples'
        run: make -C bld-cares curl-examples-build

      - name: 'AM autoreconf'
        run: autoreconf -fi

      - name: 'AM configure (out-of-tree, c-ares, zstd, gssapi)'
        run: |
          mkdir bld-am
          cd bld-am
          ../configure --disable-dependency-tracking --enable-unity --enable-warnings --enable-werror \
            --without-ssl --enable-ares --without-libssh2 --with-zstd --with-gssapi --with-librtmp \
            --prefix="$PWD"/../curl-install-am

      - name: 'AM configure log'
        if: ${{ !cancelled() }}
        run: cat bld-am/config.log 2>/dev/null || true

      - name: 'AM curl_config.h'
        run: |
          echo '::group::raw'; cat bld-am/lib/curl_config.h || true; echo '::endgroup::'
          grep -F '#define' bld-am/lib/curl_config.h | sort || true

      - name: 'AM build'
        run: make -C bld-am

      - name: 'AM curl -V'
        run: bld-am/src/curl --disable --version

      - name: 'AM install'
        run: make -C bld-am install

      - name: 'AM build tests'
        run: make -C bld-am/tests all
